services:
  agentbox:
    build:
      context: .
      # args:
      #   # 让容器内 dev 用户和宿主机用户 UID/GID 对齐，避免挂载权限乱
      #   HTTP_PROXY:  http://127.0.0.1:29870
      #   HTTPS_PROXY: http://127.0.0.1:29870
      #   ALL_PROXY:   socks5://127.0.0.1:29871
      #   NO_PROXY:    localhost,127.0.0.1,::1

    image: agentbox:latest
    container_name: agentbox
    tty: true
    stdin_open: true
    working_dir: /workspace

    user: "0:0"
    # 推荐用 .env 注入 key，不要写进镜像/compose
    env_file:
      - .env

    environment:
      AUTO_TMUX: "0"
      TMUX_SESSION: "agent"
      GIT_SSH_COMMAND: "ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=6"

    volumes:
      # 你的代码目录
      - /baai-cwm-vepfs/cwm/nan.wang/code:/workspace

      # 持久化整个 /home/node 目录（所有配置、缓存、数据都在这里）
      - agentbox_home:/home/node

      # ssh/gitconfig：从宿主机挂载（覆盖 volume 中的对应部分，只读）
      - ~/.ssh:/home/node/.ssh:ro
      - ~/.gitconfig:/home/node/.gitconfig:ro

volumes:
  agentbox_home: