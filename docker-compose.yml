services:
  agentbox:
    userns_mode: host
    build:
      context: .
      # Optional: proxy args for build stage
      # args:
      #   HTTP_PROXY:  http://127.0.0.1:29870
      #   HTTPS_PROXY: http://127.0.0.1:29870
      #   ALL_PROXY:   socks5://127.0.0.1:29871
      #   NO_PROXY:    localhost,127.0.0.1,::1

    image: agentbox:latest
    container_name: agentbox
    
    # Interactive terminal
    tty: true
    stdin_open: true
    
    # Working directory
    working_dir: /workspace

    # Run as root initially (entrypoint will drop to node user)
    user: "0:0"
    
    # Environment configuration
    # Recommended: use .env file for sensitive keys, don't hardcode in compose
    env_file:
      - .env

    environment:
      AUTO_TMUX: "0"
      TMUX_SESSION: "agent"
      GIT_SSH_COMMAND: "ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=6"

    volumes:
      # Code workspace directory
      - /baai-cwm-vepfs/cwm/nan.wang/code:/workspace

      # Persist entire /home/node directory (configs, cache, data)
      - agentbox_home:/home/node

      # SSH and git config from host (read-only, overrides volume)
      - ~/.ssh:/home/node/.ssh:ro
      - ~/.gitconfig:/home/node/.gitconfig:ro

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "node", "--version"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

    # Security options
    security_opt:
      - no-new-privileges:true

volumes:
  agentbox_home:
    driver: local